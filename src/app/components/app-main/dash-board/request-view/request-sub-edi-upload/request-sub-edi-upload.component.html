<div class="request-sub-edi-upload-container"><app-progress-spin [isLoading]="isLoading" />
  <drawer-fullscreen-file-view #fullscreenFileView />
  <drawer-image-modify-view #imageModifyView (error)="onError($event)" />
  <p-context-menu [target]="ediGalleria" [model]="contextMenu" (onShow)="contextMenuOnShow()">
    <ng-template pTemplate="item" let-item>
      <a pRipple class="flex align-items-center p-contextmenu-item-link">
        <span [class]="item.icon"></span>
        <span class="ml-2">{{item.label | translate}}</span>
      </a>
    </ng-template>
  </p-context-menu>
  <div class="flex">
    <p-ifta-label class="m-1">
      <input id="applyDate" [ngModel]="getApplyDate()" readonly pInputText />
      <label for="applyDate">{{"edi-view.apply-date" | translate}}</label>
    </p-ifta-label>
    <p-ifta-label class="m-1">
      <input id="regDate" [ngModel]="dateToYYYYMMdd(uploadModel.regDate)" readonly pInputText />
      <label for="regDate">{{"edi-view.reg-date" | translate}}</label>
    </p-ifta-label>
    <p-ifta-label class="m-1">
      <input id="hospitalName" [ngModel]="uploadModel.orgName" readonly pInputText />
      <label for="hospitalName">{{"edi-view.hospital-name" | translate}}</label>
    </p-ifta-label>
    <p-ifta-label class="m-1" *ngIf="uploadModel.etc.length > 0">
      <input id="hospitalNewName" [ngModel]="uploadModel.etc" readonly pInputText />
      <label for="hospitalNewName">{{"edi-view.hospital-new-name" | translate}}</label>
    </p-ifta-label>
  </div>
  <div class="flex">
    <p-ifta-label class="m-1">
      <input id="userId" [ngModel]="uploadModel.id" readonly pInputText />
      <label for="userId">{{"edi-view.id" | translate}}</label>
    </p-ifta-label>
    <p-ifta-label class="m-1">
      <input id="userName" [ngModel]="uploadModel.name" readonly pInputText />
      <label for="userName">{{"edi-view.user-name" | translate}}</label>
    </p-ifta-label>
    <span class="m-1 align-self-center">
      <p-tag [value]="uploadModel.ediState" [severity]="getEDIStateSeverity(uploadModel.ediState)" />
    </span>
    <p-button class="m-1 align-self-center" (click)="$event.stopPropagation(); responseNewEDI()" *ngIf="!newEDIModifyDisable()">{{"common-desc.modify" | translate}}</p-button>
  </div>
  <p-accordion [multiple]="multipleEnable">
    <p-accordion-panel *ngFor="let pharma of uploadModel.pharmaList" value="{{accordionPharmaIndex(pharma)}}">
      <p-accordion-header>
        <div>
          <span>{{pharma.orgName}}</span>
        </div>
        <div *ngIf="pharma.isCarriedOver">
          <span>{{"edi-view.carried-over" | translate}}</span>
          <span>{{"edi-view.approx-apply-date" | translate}}</span>
          <span>{{getPharmaApplyDate(pharma)}}</span>
        </div>
        <div>
          <span>{{"edi-view.edi-state" | translate}}</span>
          <span>
            <p-tag [value]="pharma.ediState" [severity]="getEDIStateSeverity(pharma.ediState)" />
            <p-button (click)="$event.stopPropagation(); responsePharma(pharma)" *ngIf="!modifyDisable(pharma)">{{"common-desc.modify" | translate}}</p-button>
          </span>
        </div>
        <div *ngIf="!modifyDisable(pharma)">
          <span>{{"common-desc.modify" | translate}}</span>
          <span>
            <p-button icon="pi pi-file-edit" (click)="$event.stopPropagation(); pharmaModify(pharma)" />
          </span>
        </div>
      </p-accordion-header>
      <p-accordion-content>
        <p-table #listTable [value]="pharma.medicineList" [scrollable]="true" [paginator]="true" [rows]="10" [tableStyle]="tableStyle" size="small" stripedRows="true">
          <ng-template #header>
            <tr>
              <th>{{"edi-view.medicine-name" | translate}}</th>
              <th>{{"edi-view.medicine-count" | translate}}</th>
              <th>{{"edi-view.medicine-charge" | translate}}</th>
              <th>{{"edi-view.medicine-price" | translate}}</th>
              <th>{{"edi-view.medicine-date" | translate}}</th>
              <th *ngIf="!modifyDisable(pharma)">{{"common-desc.modify" | translate}}</th>
              <th *ngIf="!modifyDisable(pharma)">{{"common-desc.remove" | translate}}</th>
            </tr>
          </ng-template>
          <ng-template #body let-medicine>
            <tr>
              <td>{{medicine.innerName}}</td>
              <td>
                <input type="number" [(ngModel)]="medicine.count" [disabled]="modifyDisable(pharma)">
              </td>
              <td>
                <input type="number" [(ngModel)]="medicine.charge" [disabled]="modifyDisable(pharma)">
              </td>
              <td>
                <input type="number" [(ngModel)]="medicine.price" [disabled]="modifyDisable(pharma)">
              </td>
              <td>{{getMedicineApplyDate(medicine)}}</td>
              <td *ngIf="!modifyDisable(pharma)">
                <p-button tabindex="-1" icon="pi pi-file-edit" (click)="medicineModify(medicine)" [disabled]="modifyDisable(pharma)"></p-button>
              </td>
              <td *ngIf="!modifyDisable(pharma)">
                <p-button tabindex="-1" icon="pi pi-trash" (click)="removeMedicine(pharma, medicine)" [disabled]="modifyDisable(pharma)"></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-accordion-content>
    </p-accordion-panel>
  </p-accordion>
  <p-accordion [multiple]="multipleEnable">
    <p-accordion-panel *ngFor="let response of uploadModel.responseList" value="{{accordionResponseIndex(response)}}">
      <p-accordion-header>
        <div>
          <span>{{response.pharmaName}}</span>
        </div>
        <div>
          <span>{{"edi-view.reply.edi-state" | translate}}</span>
          <p-tag [value]="response.ediState" [severity]="getEDIStateSeverity(response.ediState)" />
        </div>
        <div>
          <span>{{"edi-view.reply.reg-date" | translate}}</span>
          <span>{{dateToYYYYMMdd(response.regDate)}}</span>
        </div>
        <div>
          <span>{{"edi-view.reply.user-name" | translate}}</span>
          <span>{{response.userName}}</span>
        </div>
      </p-accordion-header>
      <p-accordion-content *ngIf="response.etc.length > 0">
        <textarea rows="5" cols="30" pTextarea [autoResize]="true" [(ngModel)]="response.etc" [readonly]="true"></textarea>
      </p-accordion-content>
    </p-accordion-panel>
  </p-accordion>
  <div class="flex" *ngIf="uploadModel.fileList.length > 0">
    <p-select class="m-1 align-content-center" [options]="uploadModel.pharmaList" [(ngModel)]="selectPrintPharma" optionLabel="orgName" />
    <p-select class="m-1 align-content-center" [options]="allTextPositionDesc()" [(ngModel)]="selectTextPosition" />
    <p-ifta-label>
      <input id="fontSize" [(ngModel)]="fontSize" type="number" pInputText />
      <label for="fontSize">{{"common-desc.font-size" | translate}}</label>
    </p-ifta-label>
    <p-color-picker class="m-1 align-content-center" [(ngModel)]="backColor" pTooltip="{{backColorTooltip | translate}}"/>
    <p-color-picker class="m-1 align-content-center" [(ngModel)]="textColor" pTooltip="{{textColorTooltip | translate}}"/>
  </div>
  <div #ediGalleria>
    <p-galleria tabindex="-1" [value]="uploadModel.fileList" indicatorsPosition="bottom" [showItemNavigators]="true" [showIndicators]="true" [showThumbnails]="false" [showIndicatorsOnItem]="false"
                [containerStyle]="galleriaContainerStyle" [numVisible]="0" [(activeIndex)]="activeIndex" *ngIf="uploadModel.fileList.length > 0">
      <ng-template pTemplate="item" let-item>
        <img [src]="getBlobUrl(item)" [alt]="item.originalFilename" class="edi-image cursor-pointer" (click)="viewEDIItem(uploadModel.fileList, item)" />
      </ng-template>
      <ng-template pTemplate="caption" let-item>
        <div class="flex">
          <p-button class="flex m-1" size="small" icon="pi pi-download" [rounded]="true" pTooltip="{{downloadFileTooltip | translate}}" (click)="downloadEDIFile(item)" />
          <div class="flex-row">
            <label class="flex">{{ellipsis(item?.originalFilename, 50)}}</label>
            <label class="flex">{{dateToYYYYMMdd(item?.regDate)}}</label>
          </div>
          <p-button class="flex m-1 justify-content-end ml-auto" size="small" icon="pi pi-times" [rounded]="true" pTooltip="{{removeFileTooltip | translate}}" (click)="removeEDIFile(item)" />
        </div>
      </ng-template>
    </p-galleria>
  </div>
</div>
